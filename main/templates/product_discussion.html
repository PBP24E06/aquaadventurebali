{% load static %}

<div id="kontainerDiscussionForm" style="display: flex; flex-direction: column; padding: 10px;">
    <h1 style="font-size: 1.5rem; font-weight: bold;">Diskusi</h1>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <p>Ada pertanyaan? Diskusikan dengan penjual atau pengguna lain</p>
        <button id="discussionTalkBtn" style="background-color: #32c866; color: white; border: none; padding: 8px 16px; border-radius: 5px; font-weight: bold;">
            Tulis Pertanyaan
        </button>
    </div>
    <div id="discussionContent" style="margin-bottom: 20px;"></div>
    <div id="addDiscussionBox" style="border-top: 1px solid #e5e5e5; padding-top: 10px; display: none;">
        <form id="addDiscussionForm" method="POST" style="display: flex; flex-direction: column;">
            {% csrf_token %} <!-- Include CSRF Token -->
            <input type="text" id="message" name="message" placeholder="Apa yang ingin Anda tanyakan mengenai produk ini?" required style="padding: 8px; border: 1px solid #e5e5e5; border-radius: 5px; margin-bottom: 10px;">
            <button type="submit" id="submitDiscussionEntry" style="background-color: #32c866; color: white; border: none; padding: 8px 16px; border-radius: 5px;">
                Save
            </button>
        </form>
    </div>
</div>

<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');
    const productId = "{{ data.id }}";

    async function getForumEntries() {
        return fetch("{% url 'main:show_forum_json' data.id %}").then(res => res.json());
    }

    async function refreshForum() {
        document.getElementById("discussionContent").innerHTML = "";
        const forumEntries = await getForumEntries();
        let htmlString = "";

        if (forumEntries.length === 0) {
            htmlString = `
                <div style="display: flex; flex-direction: column; align-items: center;">
                    <img src="{% static 'image/no-discussion.png' %}" alt="no discussion" style="width: 64px; height: 64px; margin-bottom: 8px;"/>
                    <p style="text-align: center; font-weight: bold;">Belum Ada Diskusi Produk</p>
                </div>`;
        } else {
            forumEntries.forEach((item) => {
                if (item.fields.parent === null) {
                    htmlString += `
                        <div style="display: flex; flex-direction: row; align-items: flex-start; margin-bottom: 15px;">
                            <div>
                                <img src="{% static 'image/profile-picture.png' %}" alt="user profile" style="width: 48px; height: 48px; border-radius: 50%; margin-right: 16px;"/>    
                            </div>
                            <div style="flex: 1; background-color: #f5f5f5; border-radius: 10px; padding: 10px;">
                                <div>
                                    <p style="font-weight: bold; margin-bottom: 5px;">${item.fields.commenter_name}</p>
                                    <p style="margin-bottom: 5px;">${item.fields.message}</p>
                                    ${item.fields.commenter_name === '{{ user.username }}' ? `
                                        <div style="position: relative;">
                                            <button class="three-dots-btn" style="background: none; border: none; font-size: 18px; cursor: pointer;">...</button>
                                            <div class="dropdown-content" style="display: none; position: absolute; background-color: white; min-width: 120px; box-shadow: 0px 8px 16px rgba(0, 0, 0, 0.2); z-index: 1;">
                                                <button class="delete-discussion-btn" data-id="${item.pk}" style="background: none; border: none; padding: 8px 16px; text-align: left; cursor: pointer;">Delete</button>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                                ${getRepliesForParent(item.pk, forumEntries)}
                                {% if user.is_authenticated %}
                                <form class="replyForm" data-parent-id="${item.pk}" style="display: flex; margin-top: 10px;">
                                    <input type="text" name="message" placeholder="Isi komentar disini" required style="flex: 1; padding: 8px; border: 1px solid #e5e5e5; border-radius: 5px; margin-right: 10px;">
                                    <button type="submit" style="background-color: #32c866; color: white; border: none; padding: 8px 16px; border-radius: 5px;">
                                        Save
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                        </div>`;
                }
            });
        }
        document.getElementById("discussionContent").innerHTML = htmlString;

        document.querySelectorAll('.three-dots-btn').forEach(button => {
            button.addEventListener('click', function() {
                const dropdown = this.nextElementSibling;
                dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
            });
        });

        document.querySelectorAll('.delete-discussion-btn').forEach(button => {
            button.addEventListener('click', function() {
                const discussionId = this.getAttribute('data-id');
                deleteDiscussion(discussionId);
            });
        });

        document.querySelectorAll('.replyForm').forEach(form => {
            form.onsubmit = addReply; 
        });
    }

    function getRepliesForParent(parentId, entries) {
        let replyHtml = '';
        entries.forEach((entry) => {
            if (entry.fields.parent === parentId) {
                replyHtml += `
                    <div style="display: flex; flex-direction: row; align-items: flex-start; margin-left: 50px; margin-top: 10px;">
                        <div>
                            <img src="{% static 'image/profile-picture.png' %}" alt="user profile" style="width: 32px; height: 32px; border-radius: 50%; margin-right: 16px;"/>    
                        </div>
                        <div style="flex: 1; background-color: #f0f0f0; border-radius: 10px; padding: 8px;">
                            <p style="font-weight: bold;">${entry.fields.commenter_name}</p>
                            <p>${entry.fields.message}</p>
                            ${entry.fields.commenter_name === '{{ user.username }}' ? `
                                <div style="position: relative;">
                                    <button class="three-dots-btn" style="background: none; border: none; font-size: 18px; cursor: pointer;">...</button>
                                    <div class="dropdown-content" style="display: none; position: absolute; background-color: white; min-width: 120px; box-shadow: 0px 8px 16px rgba(0, 0, 0, 0.2); z-index: 1;">
                                        <button class="delete-discussion-btn" data-id="${entry.pk}" style="background: none; border: none; padding: 8px 16px; text-align: left; cursor: pointer;">Delete</button>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>`;
            }
        });
        return replyHtml;
    }

    async function deleteDiscussion(discussionId) {
        fetch(`/delete_discussion/${discussionId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrftoken
            },
        })
        .then(response => {
            if (response.ok) {
                refreshForum(); 
            } else {
                console.error('Failed to delete discussion.');
            }
        });
    }

    async function addDiscussion(event) {
        event.preventDefault(); 

        fetch(`/add_discussion_or_reply/${productId}/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": csrftoken, 
            },
            body: new FormData(document.querySelector('#addDiscussionForm')) 
        })
        .then(response => {
            if (response.ok) {
                console.log("New discussion added successfully.");
                refreshForum(); 
                document.getElementById("addDiscussionForm").reset(); 
            } else {
                console.error('Failed to add discussion:', response.statusText);
            }
        })
        .catch(error => console.error('Error in adding discussion:', error));
    }

    document.getElementById("addDiscussionForm").onsubmit = addDiscussion;

    async function addReply(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);

        const parentId = form.getAttribute('data-parent-id');
        
        formData.append('parent_id', parentId);

        fetch(`/add_discussion_or_reply/${productId}/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": csrftoken
            },
            body: formData
        })
        .then(response => {
            if (response.ok) {
                refreshForum(); 
                form.reset(); 
            } else {
                console.error('Failed to add reply:', response.statusText);
            }
        });
    }

    const isAuthenticated = JSON.parse("{{ user.is_authenticated|yesno:'true,false' }}");

    async function showDiscussionBox() {
        if (isAuthenticated) {
            document.getElementById('addDiscussionBox').style.display = 'block';
        } else {
            document.getElementById('addDiscussionBox').style.display = 'none'; 
        }
    }

    window.onload = showDiscussionBox;

    document.getElementById('discussionTalkBtn').addEventListener('click', function() {
        if (!isAuthenticated) {
            window.location.href = "{% url 'main:login_user' %}?next={{ request.path }}";
        } else {
            const targetElement = document.getElementById('addDiscussionBox');
            targetElement.scrollIntoView({ behavior: 'smooth' });
        }
    });

    refreshForum();
</script>
